#cloud-config
chpasswd:
  expire: false
groups:
  - host-group
  - ssl-certs
users:
  - name: dummyuserlogin
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: [host-group, ssl-certs]
    shell: /bin/bash
  - name: dummyuser
    groups: [host-group, ssl-certs]
    shell: /usr/sbin/nologin
    lock_passwd: true
apt:
  sources:
    docker.list:
      source: "deb [arch=amd64] https://download.docker.com/linux/ubuntu $RELEASE stable"
      keyid: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
package_update: true
package_upgrade: true
packages:
  - acl
  - uidmap
  - fail2ban
  - certbot
  - build-essential 
  - ufw
  - jq
  - openjdk-21-jre
  - maven
  - hugo
  - protobuf-compiler
  - docker-ce
  - docker-ce-cli
  - containerd.io
  - docker-compose-plugin
  - docker-ce-rootless-extras
  - docker-buildx-plugin
write_files:
  - path: /usr/local/bin/detect-apt-proxy.sh
    permissions: '0755'
    content: |
      #!/bin/sh
      GATEWAY=$(ip route show | grep default | awk '{print $3}')
      if [ -n "$GATEWAY" ]; then
          echo "http://$GATEWAY:3142"
      else
          echo "DIRECT"
      fi
  - path: /etc/apt/apt.conf.d/00proxy-detect
    content: |
      Acquire::http::Proxy-Auto-Detect "/usr/local/bin/detect-apt-proxy.sh";
  - path: /etc/ufw/sysctl.conf
    append: true
    content: |
      net/ipv4/ip_forward=1
  - path: /etc/ufw/before.rules
    append: true
    content: |
      *nat
      :PREROUTING ACCEPT [0:0]
      -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port http-port
      -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port https-port
      COMMIT
runcmd:
  - sed -i 's/UMASK\s*022/UMASK 007/g' /etc/login.defs
  - groupmod -g 1000 host-group
  - mkdir -p project-dir
  - chmod 2770 project-dir
  - chown dummyuserlogin:host-group project-dir
  - systemctl stop sshd
  - systemctl disable sshd
  - systemctl enable fail2ban
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw default deny routed
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow http-port/tcp
  - ufw allow https-port/tcp
  - ufw allow 41641/udp
  # - ufw allow 44400:44500/udp
  - ufw --force enable
  - loginctl enable-linger dummyuserlogin
  - rm -rf /usr/local/go
  - curl -L -o /tmp/goinstall.tar.gz https://go.dev/dl/go-version.tar.gz
  - tar -C /usr/local -xzf /tmp/goinstall.tar.gz
  - rm /tmp/goinstall.tar.gz
  - echo 'export PATH=/usr/local/go/bin:$PATH' > /etc/profile.d/go.sh
  - |
    su -l dummyuserlogin -c 'bash -s' << 'EOF'
    umask 007
    git clone project-repo project-dir
    git -C project-dir config core.sharedRepository group
    mkdir -p project-dir/backups project-dir/backups/db project-dir/backups/certs project-dir/working project-dir/demos project-dir/demos/final
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
    . /home/dummyuserlogin/.nvm/nvm.sh && nvm install node-version && npm i -g pnpm@latest-10
    /usr/local/go/bin/go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
    /usr/local/go/bin/go install github.com/google/gnostic/cmd/protoc-gen-openapi@latest
    mkdir -p ~/.config/docker
    echo '{ "storage-driver": "overlay2" }' >> /home/dummyuserlogin/.config/docker/daemon.json
    /usr/bin/dockerd-rootless-setuptool.sh install
    systemctl --user enable docker
    EOF
  - curl -fsSL https://tailscale.com/install.sh | sh
  - tailscale up --operator=dummyuserlogin --authkey=ts-auth-key --ssh
  - usermod -s /usr/sbin/nologin root
